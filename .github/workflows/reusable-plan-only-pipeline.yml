name: Reusable Plan-Only CodePipeline Trigger

on:
  workflow_call:
    inputs:
      aws-region:
        description: 'AWS region for the pipeline'
        required: false
        default: 'us-west-2'
        type: string
      pipeline-name:
        description: 'Name of the CodePipeline to trigger'
        required: false
        default: 'aft-customization-plan-only'
        type: string
      timeout-minutes:
        description: 'Timeout in minutes for pipeline execution'
        required: false
        default: '30'
        type: string
      patterns:
        description: 'Comma-separated patterns to check for sensitive keywords'
        required: false
        default: 'noodle_king,secret_key,password,api_key,token'
        type: string
      file-patterns:
        description: 'Patterns to match changed files for account mapping'
        required: false
        default: |
          ^src/.*
          ^tests/.*
        type: string
    secrets:
      aws-access-key-id:
        required: true
      aws-secret-access-key:
        required: true

jobs:
  trigger-codepipeline:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ${{ inputs.aws-region }}
    outputs:
      execution-id: ${{ steps.codepipeline.outputs.execution-id }}
      platform: ${{ steps.platform.outputs.aft_account }}
      target-account: ${{ steps.account.outputs.account_number }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine platform based on target branch
        id: platform
        run: |
          PLATFORM=$([ "${{ github.ref_name }}" = "master" ] && echo "prod_account_number" || echo "dev_account_number")
          echo "aft_account=$PLATFORM" >> $GITHUB_OUTPUT
          echo "Platform: $PLATFORM"

      - name: Find changed files
        id: changes
        uses: chaunceyyann/cyan-actions/.github/actions/changed-files@v0.1
        with:
          pattern: ${{ inputs.file-patterns }}

      - name: Determine account number
        id: account
        uses: chaunceyyann/cyan-actions/.github/actions/account-mapping@v0.1
        with:
          changed-files: ${{ steps.changes.outputs.files }}
          environment: ${{ steps.platform.outputs.aft_account }}

      - name: Call AWS AFT CodePipeline Action
        id: codepipeline
        uses: chaunceyyann/cyan-actions/.github/actions/run-codepipeline@v0.1
        with:
          aws-region: ${{ env.AWS_REGION }}
          aws-target-account: ${{ steps.account.outputs.account_number }}
          aws-pipeline-account: ${{ steps.platform.outputs.aft_account }}
          commit-sha: ${{ github.sha }}
          aws-access-key-id: ${{ secrets.aws-access-key-id }}
          aws-secret-access-key: ${{ secrets.aws-secret-access-key }}

  generate-summary:
    runs-on: ubuntu-latest
    needs: trigger-codepipeline
    if: needs.trigger-codepipeline.outputs.execution-id != 'null'
    env:
      AWS_REGION: ${{ inputs.aws-region }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for sensitive keywords
        id: keyword-check
        uses: chaunceyyann/cyan-actions/.github/actions/check-keywords@v0.1
        with:
          patterns: ${{ inputs.patterns }}
          base-ref: "origin/${{ github.base_ref }}"

      - name: Check Pipeline Status
        id: pipeline-status
        uses: chaunceyyann/cyan-actions/.github/actions/check-codepipeline@v0.1
        with:
          execution-id: ${{ needs.trigger-codepipeline.outputs.execution-id }}
          pipeline-name: ${{ inputs.pipeline-name }}
          timeout-minutes: ${{ inputs.timeout-minutes }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Generate summary
        run: |
          cat << EOF >> $GITHUB_STEP_SUMMARY
          ## CodePipeline Execution Summary

          ### Execution Details
          - **Platform**: ${{ needs.trigger-codepipeline.outputs.platform }}
          - **Target Account**: ${{ needs.trigger-codepipeline.outputs.target-account }}
          - **AWS Region**: ${{ env.AWS_REGION }}

          ### Commit Information
          - **Commit SHA**: ${{ github.sha }}
          - **Commit Message**: ${{ github.event.head_commit.message }}
          - **Commit Author**: ${{ github.event.head_commit.author.name }}
          - **Commit Timestamp**: ${{ github.event.head_commit.timestamp }}

          ### Code Quality Check
          - **Sensitive Keywords Found**: ${{ steps.keyword-check.outputs.found }}

          ### Pipeline Status
          - **Execution ID**: ${{ needs.trigger-codepipeline.outputs.execution-id }}
          - **Status**: ${{ steps.pipeline-status.outputs.status }}
          - **Start Time**: ${{ steps.pipeline-status.outputs.start-time }}
          - **Pipeline Console**: [View in AWS Console](https://${{ env.AWS_REGION }}.console.aws.amazon.com/codesuite/codepipeline/pipelines/${{ inputs.pipeline-name }}/executions/${{ needs.trigger-codepipeline.outputs.execution-id }}/view?region=${{ env.AWS_REGION }})
          EOF

          if [ "${{ steps.pipeline-status.outputs.variables }}" != "" ]; then
            echo "### Pipeline Variables" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            echo '${{ steps.pipeline-status.outputs.variables }}' >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

      - name: Generate PDF report
        id: pdf-report
        uses: chaunceyyann/cyan-actions/.github/actions/generate-pdf-report@v0.1
        with:
          report-title: "CodePipeline Execution Report"
          generated-time: ${{ format('{0}', github.event.head_commit.timestamp) }}
          workflow-name: "${{ github.workflow }}"
          run-id: "${{ github.run_id }}"
          pr-number: "${{ github.event.number }}"
          pr-title: "${{ github.event.pull_request.title }}"
          execution-details: '{"Platform": "${{ needs.trigger-codepipeline.outputs.platform }}", "Target Account": "${{ needs.trigger-codepipeline.outputs.target-account }}", "AWS Region": "${{ env.AWS_REGION }}"}'
          commit-information: '{"SHA": "${{ github.sha }}", "Message": "${{ github.event.head_commit.message }}", "Author": "${{ github.event.head_commit.author.name }}", "Timestamp": "${{ github.event.head_commit.timestamp }}", "Branch": "${{ github.ref_name }}", "Base Ref": "${{ github.base_ref }}"}'
          quality-check: '{"Sensitive Keywords Found": "${{ steps.keyword-check.outputs.found }}", "Patterns Checked": "${{ inputs.patterns }}"}'
          pipeline-status: '{"Execution ID": "${{ needs.trigger-codepipeline.outputs.execution-id }}", "Status": "${{ steps.pipeline-status.outputs.status }}", "Start Time": "${{ steps.pipeline-status.outputs.start-time }}", "Console URL": "https://${{ env.AWS_REGION }}.console.aws.amazon.com/codesuite/codepipeline/pipelines/${{ inputs.pipeline-name }}/executions/${{ needs.trigger-codepipeline.outputs.execution-id }}/view?region=${{ env.AWS_REGION }}"}'
          variables: "${{ steps.pipeline-status.outputs.variables }}"
          output-filename: "pipeline-execution-report-${{ github.run_id }}"

      - name: Upload PDF report
        uses: actions/upload-artifact@v4
        with:
          name: pipeline-execution-report-${{ github.run_id }}
          path: ${{ steps.pdf-report.outputs.pdf-path }}
          retention-days: 30
