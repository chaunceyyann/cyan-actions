name: PR Status Commenter (Reusable)

on:
  workflow_call:
    inputs:
      required-checks:
        description: 'Comma-separated list of required checks to monitor'
        required: false
        default: 'pre-commit,terraform-lint,python-ci'
        type: string
      success-template:
        description: 'Success comment template (supports variables: {{checks}}, {{pr_number}}, {{repo}})'
        required: false
        default: |
          âœ… **All PR checks passed successfully!**

          ğŸ‰ Great job! All automated checks have completed successfully:
          {{checks}}

          This PR is ready for review! ğŸš€

          ğŸ“‹ **Check Results:**
          - [View all checks](https://github.com/{{repo}}/pull/{{pr_number}}/checks)

          *This comment was automatically posted by the PR Status Commenter.*
        type: string
      failure-template:
        description: 'Failure comment template (supports variables: {{checks}}, {{pr_number}}, {{repo}})'
        required: false
        default: |
          âŒ **Some PR checks failed**

          Please review the failed checks and fix any issues before requesting a review.

          ğŸ“‹ **Check Results:**
          - [View all checks](https://github.com/{{repo}}/pull/{{pr_number}}/checks)

          *This comment was automatically posted by the PR Status Commenter.*
        type: string
      prevent-duplicates:
        description: 'Prevent duplicate comments (true/false)'
        required: false
        default: 'true'
        type: string
      include-check-links:
        description: 'Include links to check results (true/false)'
        required: false
        default: 'true'
        type: string
      bot-name:
        description: 'Bot name for comment signatures'
        required: false
        default: 'PR Status Commenter'
        type: string
      codebuild-runner:
        description: 'CodeBuild runner label to use'
        required: false
        default: ''
        type: string

    secrets:
      github-token:
        description: 'GitHub token for API access'
        required: false

jobs:
  comment-on-pr:
    runs-on: ${{ inputs.codebuild-runner != '' && format('codebuild-{0}-{1}-{2}', inputs.codebuild-runner, github.run_id, github.run_attempt) || 'ubuntu-latest' }}
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Comment on PR Status
        id: comment
        uses: ./.github/actions/pr-status-commenter
        with:
          required-checks: ${{ inputs.required-checks }}
          success-template: ${{ inputs.success-template }}
          failure-template: ${{ inputs.failure-template }}
          prevent-duplicates: ${{ inputs.prevent-duplicates }}
          include-check-links: ${{ inputs.include-check-links }}
          bot-name: ${{ inputs.bot-name }}
        env:
          GITHUB_TOKEN: ${{ secrets.github-token || github.token }}

      - name: Comment Status
        run: |
          if [[ "${{ steps.comment.outputs.commented }}" == "true" ]]; then
            echo "âœ… Posted ${{ steps.comment.outputs.comment-type }} comment on PR"
          else
            echo "â„¹ï¸ No comment posted (type: ${{ steps.comment.outputs.comment-type }})"
          fi
